{% extends 'base.html' %}

{% block content %}
    <style>
    /* Estilos para dar formato al formulario */
    .formulario-autoevaluacion {
        width: 100%;
        margin-top: 20px;
        border-collapse: separate;
        border-spacing: 0 10px;
    }

    .formulario-autoevaluacion th,
    .formulario-autoevaluacion td {
        padding: 10px;
        border-bottom: 1px solid #ccc;
    }

    .formulario-autoevaluacion th {
        background-color: #f2f2f2;
    }

    /* Estilos para ajustar los elementos del formulario */
    .formulario-autoevaluacion select,
    .formulario-autoevaluacion input[type="number"],
    .formulario-autoevaluacion input[type="file"] {
        width: 100%;
        padding: 5px;
    }

    .cumple-columna {
        width: 5%; /* Ajusta el valor según tus necesidades */
    }

    .porcentaje-columna {
        width: 5%; /* Ajusta el valor según tus necesidades */
    }

    .evidencia-columna {
        width: 25%; /* Ajusta el valor según tus necesidades */
    }

    /* Reduce el ancho de otras columnas si es necesario */
    .titulo-columna {
        width: 20%; /* Puedes ajustar el valor según tus necesidades */
    }

    .item-columna {
        width: 5%; /* Puedes ajustar el valor según tus necesidades */
    }
    .descripcion-columna {
        width: 40%; /* Ajusta el valor según tus necesidades */
    }
    .btn-ver-plan {
        width: 150px; /* Ajusta el valor según tus necesidades */
    }

    /* Estilos para la ventana emergente */
    .ventana-emergente {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border: 1px solid #ccc;
        padding: 20px;
        z-index: 1000;
    }

    .ventana-contenido {
        display: flex;
        justify-content: space-between; /* Distribuir columnas en la ventana */
    }

    /* Estilo para la columna izquierda del formulario de plan de acción */
    .columna-izquierda {
        flex: 1; /* Toma el 50% del espacio en la ventana */
        padding-right: 20px; /* Espacio entre columnas */
    }

    /* Estilo para la columna derecha del listado de planes de acción */
    .columna-derecha {
        flex: 1; /* Toma el 50% del espacio en la ventana */
        padding-left: 20px; /* Espacio entre columnas */
        border-left: 1px solid #ccc; /* Línea divisoria entre columnas */
    }
    </style>

    <h2>{{ protocolo_seleccionado.nombre }}</h2>
    <form method="post">
        {% csrf_token %}
        <table class="formulario-autoevaluacion">
            <thead>
                <tr>
                    <th class="titulo-columna">Sector/Requisito</th>
                    <th class="item-columna">Ítem</th>
                    <th class="descripcion-columna">Ítem a evaluar</th>
                    <th class="porcentaje-columna">¿Cumple?</th>
                    <th class="porcentaje-columna">Porcentaje</th>
                    <th class="evidencia-columna">Subir Evidencia</th>
                    <th>Plan de Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for item_evaluacion in items_evaluacion %}
                <tr>
                    <td class="titulo-columna">{{ item_evaluacion.titulo }}</td>
                    <td class="item-columna">{{ item_evaluacion.item }}</td>
                    <td class="descripcion-columna">{{ item_evaluacion.item_a_evaluar }}</td>
                    <td class="cumple-columna">
                        <select name="aplica_{{ item_evaluacion.id_item }}" class="aplica-select">
                            <option value="-" selected disabled>-</option>
                            <option value="Si">Sí</option>
                            <option value="No">No</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </td>
                    <td class="porcentaje-columna">
                        <input type="number" name="porcentaje_{{ item_evaluacion.id_item }}" min="0" max="100"
                            class="porcentaje-input" readonly />
                    </td>
                    <td>
                        <input type="file" name="evidencia_{{ item_evaluacion.id_item }}" accept=".pdf, .docx"
                            class="evidencia-input" disabled />
                    </td>
                    <td class="evidencia-columna">
                        <button class="btn-ver-plan plan-accion-button" data-item="{{ item_evaluacion.item_a_evaluar }}" data-oportunidad-id="{{ item_evaluacion.id_item }}" disabled>Ver Plan de Acción</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit">Guardar Respuestas</button>
    </form>

    <div id="ventanaPlanAccion" class="ventana-emergente">
        <div class="ventana-contenido">
            <span class="cerrar" id="cerrarVentanaPlan">&times;</span>
            <div class="columna-izquierda">
                <h2>Plan de Acción</h2>
                <form method="post" id="OportunidadmejoraForm">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit">Guardar</button>
                </form>
            </div>
            <div class="columna-derecha">
                <h3>Listado de Planes de Acción</h3>
                <ul id="listaPlanesAccion">
                    <!-- Aquí se mostrará la lista de planes de acción -->
                </ul>
            </div>
        </div>
    </div>

    <script>
    // Obtener elementos HTML
    document.addEventListener('DOMContentLoaded', function () {
        const aplicaSelects = document.querySelectorAll('.aplica-select');
        const porcentajeInputs = document.querySelectorAll('.porcentaje-input');
        const evidenciaInputs = document.querySelectorAll('.evidencia-input');
        const verPlanButtons = document.querySelectorAll('.btn-ver-plan');
        const cumpleNoCumpleSelects = document.querySelectorAll('.cumple-no-cumple-select');

        // Agregar evento de cambio a los selects para controlar los elementos
        aplicaSelects.forEach((select, index) => {
            select.addEventListener('change', () => {
                const porcentajeInput = porcentajeInputs[index];
                const evidenciaInput = evidenciaInputs[index];
                const verPlanButton = verPlanButtons[index];
                const cumpleNoCumpleSelect = cumpleNoCumpleSelects[index];

                if (select.value === 'Si') {
                    porcentajeInput.value = 100;
                    porcentajeInput.setAttribute('readonly', 'readonly');
                    evidenciaInput.removeAttribute('disabled');
                    evidenciaInput.value = '';
                    verPlanButton.setAttribute('disabled', 'disabled');
                    cumpleNoCumpleSelect.value = 'Cumple';
                    cumpleNoCumpleSelect.removeAttribute('disabled');
                } else if (select.value === 'No') {
                    porcentajeInput.value = 0;
                    porcentajeInput.setAttribute('readonly', 'readonly');
                    evidenciaInput.removeAttribute('disabled');
                    verPlanButton.removeAttribute('disabled');
                    cumpleNoCumpleSelect.value = 'NoCumple';
                    cumpleNoCumpleSelect.removeAttribute('disabled');
                } else {
                    porcentajeInput.value = null;
                    porcentajeInput.setAttribute('readonly', 'readonly');
                    evidenciaInput.setAttribute('disabled', 'disabled');
                    evidenciaInput.value = '';
                    verPlanButton.setAttribute('disabled', 'disabled');
                    cumpleNoCumpleSelect.value = null;
                    cumpleNoCumpleSelect.removeAttribute('disabled');
                }
            });
        });

        // Agregar evento de clic a los botones "Plan de Acción"
        verPlanButtons.forEach((button, index) => {
            button.addEventListener('click', (event) => {
                // Prevenir el comportamiento predeterminado del enlace
                event.preventDefault();

                // Muestra la ventana emergente
                document.getElementById('ventanaPlanAccion').style.display = 'block';

                // Acceder a los atributos de datos para obtener información del ítem
                const item = button.getAttribute('data-item');
                const oportunidadId = button.getAttribute('data-oportunidad-id');

                // Aquí puedes cargar información relacionada con el ítem y el plan de acción si es necesario
            });
        });

        // Agregar evento de clic al botón para cerrar la ventana emergente
        document.getElementById('cerrarVentanaPlan').addEventListener('click', () => {
            cerrarVentanaPlan();
        });

        // Función para cerrar la ventana emergente
        function cerrarVentanaPlan() {
            document.getElementById('ventanaPlanAccion').style.display = 'none';
        }
    });
</script>
{% endblock %}
